module.exports=function(C){C.nodes.registerType("plc_omron",function(r){C.nodes.createNode(this,r),this.host=r.host,this.port=+r.port,this.indexPLC=r.indexPLC,this.PLC_WriteUnSafe=r.PLC_WriteUnSafe,this.PLC_Interval=50<=parseInt(r.PLC_Interval)?r.PLC_Interval:50,this.PLC_Length_ReadWrite=0<parseInt(r.PLC_Length_ReadWrite)?r.PLC_Length_ReadWrite:10,this.PLC_Word_Start_ReadWrite=r.PLC_Word_Start_ReadWrite,this.PLC_WordStartElement=r.PLC_WordStartElement,this.PLC_LengthOfWordElement=r.PLC_LengthOfWordElement,this.PLC_WordStartBitDisplay=r.PLC_WordStartBitDisplay,this.PLC_LengthOfWordBitDisplay=r.PLC_LengthOfWordBitDisplay,this.PLC_WordStartBitAdjust=r.PLC_WordStartBitAdjust,this.PLC_LengthOfWordBitAdjust=r.PLC_LengthOfWordBitAdjust,this.PLC_WordStartWordDisplay=r.PLC_WordStartWordDisplay,this.PLC_LengthOfWordWordDisplay=r.PLC_LengthOfWordWordDisplay,this.PLC_WordStartWordAdjust=r.PLC_WordStartWordAdjust,this.PLC_LengthOfWordWordAdjust=r.PLC_LengthOfWordWordAdjust,this.PLC_WordStartDWordDisplay=r.PLC_WordStartDWordDisplay,this.PLC_LengthOfWordDWordDisplay=r.PLC_LengthOfWordDWordDisplay,this.PLC_WordStartDWordAdjust=r.PLC_WordStartDWordAdjust,this.PLC_LengthOfWordDWordAdjust=r.PLC_LengthOfWordDWordAdjust,this.PLC_WordStartComPC=r.PLC_WordStartComPC,this.PLC_LengthOfWordComPC=r.PLC_LengthOfWordComPC,this.PLC_Enable_String=r.PLC_Enable_String,this.PLC_WordStartString=r.PLC_WordStartString,this.PLC_LengthOfWordString=r.PLC_LengthOfWordString,this.PLC_NumberWordInString=r.PLC_NumberWordInString,this.PLC_IntervalWriteData=r.PLC_IntervalWriteData;var t=this.context().global,n=t.get("Variable"),e=t.get("VariableSystem"),d=t.get("SubFunction"),o=(this.topic=r.topic,{}),a=(this.plc=null,this.closing=!1,this.connected=!1,this),L=0,i={},s=[];a.outstandingTimers=[],a.outstandingIntervals=[],a.on("close",function(){for(a.status({}),a.plc=null;0<a.outstandingTimers.length;)clearTimeout(a.outstandingTimers.pop());for(;0<a.outstandingIntervals.length;)clearInterval(a.outstandingIntervals.pop())}),a.on("input",function(t){"Toogle"==t.payload.length_recei_fins&&(console.log("Toggle Debug "+i.length_recei_fins),i.length_recei_fins=!i.length_recei_fins),"Check_Data_Node"==t.payload&&(o.payload={plc:a.plc,host:a.host,port:a.port,indexPLC:a.indexPLC,PLC_WriteUnSafe:a.PLC_WriteUnSafe,PLC_Interval:a.PLC_Interval,PLC_Length_ReadWrite:a.PLC_Length_ReadWrite,PLC_Word_Start_ReadWrite:a.PLC_Word_Start_ReadWrite,PLC_WordStartElement:a.PLC_WordStartElement,PLC_LengthOfWordElement:a.PLC_LengthOfWordElement,PLC_WordStartBitDisplay:a.PLC_WordStartBitDisplay,PLC_LengthOfWordBitDisplay:a.PLC_LengthOfWordBitDisplay,PLC_WordStartBitAdjust:a.PLC_WordStartBitAdjust,PLC_LengthOfWordBitAdjust:a.PLC_LengthOfWordBitAdjust,PLC_WordStartWordDisplay:a.PLC_WordStartWordDisplay,PLC_LengthOfWordWordDisplay:a.PLC_LengthOfWordWordDisplay,PLC_WordStartWordAdjust:a.PLC_WordStartWordAdjust,PLC_LengthOfWordWordAdjust:a.PLC_LengthOfWordWordAdjust,PLC_WordStartDWordDisplay:a.PLC_WordStartDWordDisplay,PLC_LengthOfWordDWordDisplay:a.PLC_LengthOfWordDWordDisplay,PLC_WordStartDWordAdjust:a.PLC_WordStartDWordAdjust,PLC_LengthOfWordDWordAdjust:a.PLC_LengthOfWordDWordAdjust,PLC_WordStartComPC:a.PLC_WordStartComPC,PLC_LengthOfWordComPC:a.PLC_LengthOfWordComPC,PLC_Enable_String:a.PLC_Enable_String,PLC_WordStartString:a.PLC_WordStartString,PLC_LengthOfWordString:a.PLC_LengthOfWordString,PLC_NumberWordInString:a.PLC_NumberWordInString,PLC_IntervalWriteData:a.PLC_IntervalWriteData},a.send(o)),void 0!==t.payload.PLC&&null==this.plc&&(e.PLC_WordStartElement[parseInt(a.indexPLC)]=a.PLC_WordStartElement,e.PLC_LengthOfWordElement[parseInt(a.indexPLC)]=a.PLC_LengthOfWordElement,e.PLC_WordStartBitDisplay[parseInt(a.indexPLC)]=a.PLC_WordStartBitDisplay,e.PLC_LengthOfWordBitDisplay[parseInt(a.indexPLC)]=a.PLC_LengthOfWordBitDisplay,e.PLC_WordStartBitAdjust[parseInt(a.indexPLC)]=a.PLC_WordStartBitAdjust,e.PLC_LengthOfWordBitAdjust[parseInt(a.indexPLC)]=a.PLC_LengthOfWordBitAdjust,e.PLC_WordStartWordDisplay[parseInt(a.indexPLC)]=a.PLC_WordStartWordDisplay,e.PLC_LengthOfWordWordDisplay[parseInt(a.indexPLC)]=a.PLC_LengthOfWordWordDisplay,e.PLC_WordStartWordAdjust[parseInt(a.indexPLC)]=a.PLC_WordStartWordAdjust,e.PLC_LengthOfWordWordAdjust[parseInt(a.indexPLC)]=a.PLC_LengthOfWordWordAdjust,e.PLC_WordStartDWordDisplay[parseInt(a.indexPLC)]=a.PLC_WordStartDWordDisplay,e.PLC_LengthOfWordDWordDisplay[parseInt(a.indexPLC)]=a.PLC_LengthOfWordDWordDisplay,e.PLC_WordStartDWordAdjust[parseInt(a.indexPLC)]=a.PLC_WordStartDWordAdjust,e.PLC_LengthOfWordDWordAdjust[parseInt(a.indexPLC)]=a.PLC_LengthOfWordDWordAdjust,e.PLC_WriteUnSafe[parseInt(a.indexPLC)]=a.PLC_WriteUnSafe,e.PLC_WordStartComPC[parseInt(a.indexPLC)]=a.PLC_WordStartComPC,e.PLC_LengthOfWordComPC[parseInt(a.indexPLC)]=a.PLC_LengthOfWordComPC,e.PLC_IntervalWriteData[parseInt(a.indexPLC)]=a.PLC_IntervalWriteData,e.PLC_Enable_String[parseInt(a.indexPLC)]=a.PLC_Enable_String,e.PLC_WordStartString[parseInt(a.indexPLC)]=a.PLC_WordStartString,e.PLC_LengthOfWordString[parseInt(a.indexPLC)]=a.PLC_LengthOfWordString,e.PLC_NumberWordInString[parseInt(a.indexPLC)]=a.PLC_NumberWordInString,a.plc=t.payload.PLC.FinsClient(r.port,r.host),e.COMMUNICATION_PLC_OMRON[parseInt(a.indexPLC)]=a.plc,a.plc.on("open",function(){a.log(C._("status.openconnection")),a.status({fill:"green",shape:"dot",text:"status.openconnection"})}),a.plc.on("error",function(t){a.log(C._("status.error")),a.status({fill:"grey",shape:"dot",text:"Error:"+t})}),a.plc.on("close",function(t){a.log(C._("status.close")),a.status({fill:"grey",shape:"dot",text:"status.close"})}),a.plc.on("reply",function(r){if(n.Timer_Check_Connect_Status[parseInt(a.indexPLC)]=2,9999<(L+=1)&&(L=0),a.status({fill:"green",shape:"dot",text:"Getting data..."+L.toString()}),i.length_recei_fins&&a.warn(r.values.length),"0101"==r.command&&500<=r.values.length){for(let t=0;t<r.values.length;t++){var e=r.values.length%500;s[500*e+e*(1+e)/2-e+t]=r.values[t]}n.Element[parseInt(a.indexPLC)]=d.ReadWordOfPLC(parseInt(a.PLC_WordStartElement),parseInt(a.PLC_LengthOfWordElement),s),n.BitAdjust[parseInt(a.indexPLC)]=d.ReadBitOfPLC(parseInt(a.PLC_WordStartBitAdjust),parseInt(a.PLC_LengthOfWordBitAdjust),s),n.WordBitAdjust[parseInt(a.indexPLC)]=d.ReadWordOfPLC(parseInt(a.PLC_WordStartBitAdjust),parseInt(a.PLC_LengthOfWordBitAdjust),s),n.BitDisplay[parseInt(a.indexPLC)]=d.ReadBitOfPLC(parseInt(a.PLC_WordStartBitDisplay),parseInt(a.PLC_LengthOfWordBitDisplay),s),n.WordDisplay[parseInt(a.indexPLC)]=d.ReadWordOfPLC(parseInt(a.PLC_WordStartWordDisplay),parseInt(a.PLC_LengthOfWordWordDisplay),s),n.WordAdjust[parseInt(a.indexPLC)]=d.ReadWordOfPLC(parseInt(a.PLC_WordStartWordAdjust),parseInt(a.PLC_LengthOfWordWordAdjust),s),n.DWordDisplay[parseInt(a.indexPLC)]=d.ReadDWordOfPLC(parseInt(a.PLC_WordStartDWordDisplay),parseInt(a.PLC_LengthOfWordDWordDisplay),s),n.DWordAdjust[parseInt(a.indexPLC)]=d.ReadDWordOfPLC(parseInt(a.PLC_WordStartDWordAdjust),parseInt(a.PLC_LengthOfWordDWordAdjust),s),n.ValueCommunicationPLC[parseInt(a.indexPLC)]=d.ReadWordOfPLC(parseInt(a.PLC_WordStartCommunicationPLC),parseInt(a.PLC_LengthOfWordCommunicationPLC),s),parseInt(a.PLC_Enable_String)&&(n.ListString[parseInt(a.indexPLC)]=d.ReadStringOfPLC_NodeRed(parseInt(a.PLC_WordStartString),parseInt(a.PLC_LengthOfWordString),parseInt(a.PLC_NumberWordInString),s)),n.WordBitAdjust[parseInt(a.indexPLC)]&&(n.OldWordBitAdjust[parseInt(a.indexPLC)]=n.WordBitAdjust[parseInt(a.indexPLC)].slice())}}),t=setInterval(function(){let r=parseInt(a.PLC_Word_Start_ReadWrite);for(let t=0;t<20;t++)a.plc.read("D"+r,500+parseInt(t),function(t,r){}),r+500+parseInt(t)>=parseInt(a.PLC_Length_ReadWrite)&&(t=1e3),r=r+500+parseInt(t)},parseInt(a.PLC_Interval)),a.outstandingIntervals.push(t),t=setInterval(function(){0<e.TimeDelayWriteWordBitAdjust[parseInt(a.indexPLC)]&&(e.TimeDelayWriteWordBitAdjust[parseInt(a.indexPLC)]=e.TimeDelayWriteWordBitAdjust[parseInt(a.indexPLC)]-1)},100),a.outstandingIntervals.push(t))})})};