const VncClient=require("vnc-rfb-client"),Jimp=require("jimp");module.exports=function(s){s.nodes.registerType("vnc_setup",function(e){s.nodes.createNode(this,e),this.host=e.host,this.port=+e.port,this.fps=+e.fps,this.indexVNC=e.indexVNC,this.password=e.password,this.checkbox_copyRect=e.checkbox_copyRect,this.checkbox_zrle=e.checkbox_zrle,this.checkbox_hextile=e.checkbox_hextile,this.checkbox_raw=e.checkbox_raw,this.checkbox_pseudoDesktopSize=e.checkbox_pseudoDesktopSize,this.checkbox_pseudoCursor=e.checkbox_pseudoCursor,this.checkbox_corre=e.checkbox_corre,this.checkbox_pseudoQemuAudio=e.checkbox_pseudoQemuAudio,this.checkbox_pseudoQemuPointerMotionChange=e.checkbox_pseudoQemuPointerMotionChange,this.checkbox_rre=e.checkbox_rre,this.checkbox_tight=e.checkbox_tight;var t=this.context().global,n=(t.get("Variable"),t.get("VariableSystem")),c=(t.get("SubFunction"),this.topic=e.topic,{}),i=(this.vnc=null,this.closing=!1,this.connected=!1,this),o=0;i.outstandingTimers=[],i.outstandingIntervals=[],i.on("close",function(){for(i.status({}),i.vnc.disconnect(),i.vnc=null,n.COMMUNICATION_VNC_INITIAL_DATA[parseInt(i.indexVNC)]={x:0,y:0,width:0,height:0,image:[]},n.IO.sockets.emit("frame_vnc_"+i.indexVNC.toString(),{x:0,y:0,width:0,height:0,image:[]});0<i.outstandingTimers.length;)clearTimeout(i.outstandingTimers.pop());for(;0<i.outstandingIntervals.length;)clearInterval(i.outstandingIntervals.pop())}),i.on("input",function(e){"Check_Data_Node"==e.payload&&(c.payload={plc:i.vnc,host:i.host,port:i.port,indexVNC:i.indexVNC},i.send(c));e={vnc:i.vnc,connect:!1,disconnect:!1},n.COMMUNICATION_VNC[parseInt(i.indexVNC)]=e,e=setInterval(()=>{var e;n.COMMUNICATION_VNC[parseInt(i.indexVNC)].connect&&(n.COMMUNICATION_VNC[parseInt(i.indexVNC)].connect=!1,null==this.vnc&&(e=[],i.checkbox_copyRect&&e.push(VncClient.consts.encodings.copyRect),i.checkbox_zrle&&e.push(VncClient.consts.encodings.zrle),i.checkbox_hextile&&e.push(VncClient.consts.encodings.hextile),i.checkbox_raw&&e.push(VncClient.consts.encodings.raw),i.checkbox_pseudoDesktopSize&&e.push(VncClient.consts.encodings.pseudoDesktopSize),i.checkbox_pseudoCursor&&e.push(VncClient.consts.encodings.pseudoCursor),i.checkbox_corre&&e.push(VncClient.consts.encodings.corre),i.checkbox_pseudoQemuAudio&&e.push(VncClient.consts.encodings.pseudoQemuAudio),i.checkbox_pseudoQemuPointerMotionChange&&e.push(VncClient.consts.encodings.pseudoQemuPointerMotionChange),i.checkbox_rre&&e.push(VncClient.consts.encodings.rre),i.checkbox_tight&&e.push(VncClient.consts.encodings.tight),e={debug:!0,encodings:e,debugLevel:1},i.vnc=new VncClient(e),i.vnc.changeFps(i.fps),i.vnc&&i.vnc.connect({host:i.host,port:i.port,password:i.password}),i.vnc.on("firstFrameUpdate",()=>{i.status({fill:"green",shape:"dot",text:"status.openconnection"});var e={vnc:i.vnc,connect:!1,disconnect:!1};n.COMMUNICATION_VNC[parseInt(i.indexVNC)]=e}),i.vnc.on("frameUpdated",e=>{9999<(o+=1)&&(o=0),i.status({fill:"green",shape:"dot",text:"Frame Updated..."+o.toString()}),new Jimp({width:i.vnc.clientWidth,height:i.vnc.clientHeight,data:i.vnc.getFb()},(e,t)=>{e&&console.log(e),t.getBase64(Jimp.AUTO,(e,t)=>{n.IO.sockets.emit("frame_vnc_"+i.indexVNC.toString(),{x:0,y:0,width:i.vnc.clientWidth,height:i.vnc.clientHeight,image:t}),n.COMMUNICATION_VNC_INITIAL_DATA[parseInt(i.indexVNC)]={x:0,y:0,width:i.vnc.clientWidth,height:i.vnc.clientHeight,image:t}})})}),i.vnc.on("connectError",e=>{i.status({fill:"red",shape:"dot",text:e}),i.vnc.connect({host:i.host,port:i.port,password:i.password}),n.IO.sockets.emit("frame_vnc_"+i.indexVNC.toString(),{x:0,y:0,width:i.vnc.clientWidth,height:i.vnc.clientHeight,image:[]}),n.COMMUNICATION_VNC_INITIAL_DATA[parseInt(i.indexVNC)]={x:0,y:0,width:i.vnc.clientWidth,height:i.vnc.clientHeight,image:[]}}),i.vnc.on("authError",()=>{console.log("Authentication failed."),i.status({fill:"red",shape:"dot",text:"Authentication failed"}),n.IO.sockets.emit("frame_vnc_"+i.indexVNC.toString(),{x:0,y:0,width:i.vnc.clientWidth,height:i.vnc.clientHeight,image:[]}),n.COMMUNICATION_VNC_INITIAL_DATA[parseInt(i.indexVNC)]={x:0,y:0,width:i.vnc.clientWidth,height:i.vnc.clientHeight,image:[]}})),i.status({fill:"blue",shape:"dot",text:"Connect Press"})),n.COMMUNICATION_VNC[parseInt(i.indexVNC)].disconnect&&(n.COMMUNICATION_VNC[parseInt(i.indexVNC)].disconnect=!1,i.status({fill:"blue",shape:"dot",text:"Disnable Press"}),i.vnc&&i.vnc.disconnect(),n.IO.sockets.emit("frame_vnc_"+i.indexVNC.toString(),{x:0,y:0,width:i.vnc.clientWidth,height:i.vnc.clientHeight,image:[]}),n.COMMUNICATION_VNC_INITIAL_DATA[parseInt(i.indexVNC)]={x:0,y:0,width:i.vnc.clientWidth,height:i.vnc.clientHeight,image:[]},i.vnc=null)},1e3);i.outstandingIntervals.push(e)})})};