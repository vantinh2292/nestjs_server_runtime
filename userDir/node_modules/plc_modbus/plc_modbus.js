var modbus=require("jsmodbus"),ModbusRTU=require("modbus-serial");module.exports=function(C){C.nodes.registerType("plc_modbus",function(t){C.nodes.createNode(this,t),this.host=t.host,this.port=+t.port,this.indexPLC=t.indexPLC,this.PLC_WriteUnSafe=t.PLC_WriteUnSafe,this.PLC_Interval=50<=t.PLC_Interval?t.PLC_Interval:50,this.PLC_Length_ReadWrite=0<t.PLC_Length_ReadWrite?t.PLC_Length_ReadWrite:10,this.PLC_Word_Start_ReadWrite=t.PLC_Word_Start_ReadWrite,this.PLC_WordStartElement=t.PLC_WordStartElement,this.PLC_LengthOfWordElement=t.PLC_LengthOfWordElement,this.PLC_WordStartBitDisplay=t.PLC_WordStartBitDisplay,this.PLC_LengthOfWordBitDisplay=t.PLC_LengthOfWordBitDisplay,this.PLC_WordStartBitAdjust=t.PLC_WordStartBitAdjust,this.PLC_LengthOfWordBitAdjust=t.PLC_LengthOfWordBitAdjust,this.PLC_WordStartWordDisplay=t.PLC_WordStartWordDisplay,this.PLC_LengthOfWordWordDisplay=t.PLC_LengthOfWordWordDisplay,this.PLC_WordStartWordAdjust=t.PLC_WordStartWordAdjust,this.PLC_LengthOfWordWordAdjust=t.PLC_LengthOfWordWordAdjust,this.PLC_WordStartDWordDisplay=t.PLC_WordStartDWordDisplay,this.PLC_LengthOfWordDWordDisplay=t.PLC_LengthOfWordDWordDisplay,this.PLC_WordStartDWordAdjust=t.PLC_WordStartDWordAdjust,this.PLC_LengthOfWordDWordAdjust=t.PLC_LengthOfWordDWordAdjust,this.PLC_WordStartRotate=t.PLC_WordStartRotate,this.PLC_LengthOfWordRotate=t.PLC_LengthOfWordRotate,this.PLC_WordStartComPC=t.PLC_WordStartComPC,this.PLC_LengthOfWordComPC=t.PLC_LengthOfWordComPC,this.PLC_Enable_String=t.PLC_Enable_String,this.PLC_WordStartString=t.PLC_WordStartString,this.PLC_LengthOfWordString=t.PLC_LengthOfWordString,this.PLC_NumberWordInString=t.PLC_NumberWordInString,this.PLC_IntervalWriteData=t.PLC_IntervalWriteData,this.topic=t.topic,this.plc=null,this.closing=!1,this.connected=!1;var s=this,e=((t=this.context().global).get("Variable"),t.get("VariableSystem"));t.get("SubFunction"),s.outstandingTimers=[],s.outstandingIntervals=[],s.on("close",function(){for(s.plc&&(s.plc.autoReconnect=!1,s.plc.close());0<s.outstandingTimers.length;)clearTimeout(s.outstandingTimers.pop());for(;0<s.outstandingIntervals.length;)clearInterval(s.outstandingIntervals.pop());s.status({})}),s.on("input",function(t){if("Close_PLC"==t.payload){for(s.plc=null,s.status({});0<s.outstandingTimers.length;)clearTimeout(s.outstandingTimers.pop());for(;0<s.outstandingIntervals.length;)clearInterval(s.outstandingIntervals.pop())}if(null==s.plc){s.log(C._("Have INPUT")),e.PLC_WordStartElement[parseInt(s.indexPLC)]=s.PLC_WordStartElement,e.PLC_LengthOfWordElement[parseInt(s.indexPLC)]=s.PLC_LengthOfWordElement,e.PLC_WordStartBitDisplay[parseInt(s.indexPLC)]=s.PLC_WordStartBitDisplay,e.PLC_LengthOfWordBitDisplay[parseInt(s.indexPLC)]=s.PLC_LengthOfWordBitDisplay,e.PLC_WordStartBitAdjust[parseInt(s.indexPLC)]=s.PLC_WordStartBitAdjust,e.PLC_LengthOfWordBitAdjust[parseInt(s.indexPLC)]=s.PLC_LengthOfWordBitAdjust,e.PLC_WordStartWordDisplay[parseInt(s.indexPLC)]=s.PLC_WordStartWordDisplay,e.PLC_LengthOfWordWordDisplay[parseInt(s.indexPLC)]=s.PLC_LengthOfWordWordDisplay,e.PLC_WordStartWordAdjust[parseInt(s.indexPLC)]=s.PLC_WordStartWordAdjust,e.PLC_LengthOfWordWordAdjust[parseInt(s.indexPLC)]=s.PLC_LengthOfWordWordAdjust,e.PLC_WordStartDWordDisplay[parseInt(s.indexPLC)]=s.PLC_WordStartDWordDisplay,e.PLC_LengthOfWordDWordDisplay[parseInt(s.indexPLC)]=s.PLC_LengthOfWordDWordDisplay,e.PLC_WordStartDWordAdjust[parseInt(s.indexPLC)]=s.PLC_WordStartDWordAdjust,e.PLC_LengthOfWordDWordAdjust[parseInt(s.indexPLC)]=s.PLC_LengthOfWordDWordAdjust,e.PLC_WriteUnSafe[parseInt(s.indexPLC)]=s.PLC_WriteUnSafe,e.PLC_WordStartRotate[parseInt(s.indexPLC)]=s.PLC_WordStartRotate,e.PLC_LengthOfWordRotate[parseInt(s.indexPLC)]=s.PLC_LengthOfWordRotate,e.PLC_WordStartComPC[parseInt(s.indexPLC)]=s.PLC_WordStartComPC,e.PLC_LengthOfWordComPC[parseInt(s.indexPLC)]=s.PLC_LengthOfWordComPC,e.PLC_IntervalWriteData[parseInt(s.indexPLC)]=s.PLC_IntervalWriteData,e.PLC_Enable_String[parseInt(s.indexPLC)]=s.PLC_Enable_String,e.PLC_WordStartString[parseInt(s.indexPLC)]=s.PLC_WordStartString,e.PLC_LengthOfWordString[parseInt(s.indexPLC)]=s.PLC_LengthOfWordString,e.PLC_NumberWordInString[parseInt(s.indexPLC)]=s.PLC_NumberWordInString,s.plc=new ModbusRTU;const a=s.PLC_Word_Start_ReadWrite,i=125,L=s.PLC_Length_ReadWrite;let o=Buffer.alloc(0),n=0;function d(){s.plc.connectTCP(host,{port:port},function(t){t?(console.error("Error connecting to Modbus device:",t),setTimeout(d,5e3)):(console.log("Connected to Modbus device"),r(),setInterval(()=>{r()},1e3))})}function r(){var t=L-n;const e=Math.min(i,t);s.plc.readHoldingRegisters(a+n/2,e,function(t,r){t?(console.error("Error reading Modbus data:",t),s.plc.close(function(){setTimeout(d,5e3)})):(o=Buffer.concat([o,Buffer.from(r.data)]),(n+=e)>=L&&(console.log("Read complete:",o),o=Buffer.alloc(0),n=0))})}d()}else s.log(C._(typeof t.payload.debug)),debug=t.payload.debug})})};