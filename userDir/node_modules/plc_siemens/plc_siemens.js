module.exports=function(C){C.nodes.registerType("plc_siemens",function(t){C.nodes.createNode(this,t),this.host=t.host,this.port=+t.port,this.rack=+t.rack,this.slot=+t.slot,this.indexPLC=t.indexPLC,this.PLC_WriteUnSafe=t.PLC_WriteUnSafe,this.PLC_Interval=50<=parseInt(t.PLC_Interval)?t.PLC_Interval:50,this.PLC_Length_ReadWrite=0<parseInt(t.PLC_Length_ReadWrite)?t.PLC_Length_ReadWrite:10,this.PLC_Word_Start_ReadWrite=t.PLC_Word_Start_ReadWrite,this.PLC_WordStartElement=t.PLC_WordStartElement,this.PLC_LengthOfWordElement=t.PLC_LengthOfWordElement,this.PLC_WordStartBitDisplay=t.PLC_WordStartBitDisplay,this.PLC_LengthOfWordBitDisplay=t.PLC_LengthOfWordBitDisplay,this.PLC_WordStartBitAdjust=t.PLC_WordStartBitAdjust,this.PLC_LengthOfWordBitAdjust=t.PLC_LengthOfWordBitAdjust,this.PLC_WordStartWordDisplay=t.PLC_WordStartWordDisplay,this.PLC_LengthOfWordWordDisplay=t.PLC_LengthOfWordWordDisplay,this.PLC_WordStartWordAdjust=t.PLC_WordStartWordAdjust,this.PLC_LengthOfWordWordAdjust=t.PLC_LengthOfWordWordAdjust,this.PLC_WordStartDWordDisplay=t.PLC_WordStartDWordDisplay,this.PLC_LengthOfWordDWordDisplay=t.PLC_LengthOfWordDWordDisplay,this.PLC_WordStartDWordAdjust=t.PLC_WordStartDWordAdjust,this.PLC_LengthOfWordDWordAdjust=t.PLC_LengthOfWordDWordAdjust,this.PLC_WordStartRotate=t.PLC_WordStartRotate,this.PLC_LengthOfWordRotate=t.PLC_LengthOfWordRotate,this.PLC_WordStartComPC=t.PLC_WordStartComPC,this.PLC_LengthOfWordComPC=t.PLC_LengthOfWordComPC,this.PLC_Enable_String=t.PLC_Enable_String,this.PLC_WordStartString=t.PLC_WordStartString,this.PLC_LengthOfWordString=t.PLC_LengthOfWordString,this.PLC_NumberWordInString=t.PLC_NumberWordInString,this.PLC_IntervalWriteData=t.PLC_IntervalWriteData;var r=this.context().global,d=r.get("Variable"),a=r.get("VariableSystem"),o=r.get("SubFunction"),n=(this.topic=t.topic,{}),L=(this.plc=null,this.closing=!1,this.connected=!1,this),i=0;L.outstandingTimers=[],L.outstandingIntervals=[],L.on("close",function(){for(L.status({}),L.plc=null;0<L.outstandingTimers.length;)clearTimeout(L.outstandingTimers.pop());for(;0<L.outstandingIntervals.length;)clearInterval(L.outstandingIntervals.pop())}),L.on("input",function(t){function r(t,r){t&&(L.status({fill:"grey",shape:"dot",text:"Error: READ WRONG"}),L.log(C._("READ WRONG"))),r&&("BAD 255"===r.DataRegister[0]?L.status({fill:"red",shape:"dot",text:"Disconnect PLC"}):(9999<(i+=1)&&(i=0),L.status({fill:"green",shape:"dot",text:"Getting data..."+i.toString()})),d.Element[parseInt(L.indexPLC)]=o.ReadWordOfPLC(parseInt(L.PLC_WordStartElement),parseInt(L.PLC_LengthOfWordElement),r.DataRegister),d.BitAdjust[parseInt(L.indexPLC)]=o.ReadBitOfPLC(parseInt(L.PLC_WordStartBitAdjust),parseInt(L.PLC_LengthOfWordBitAdjust),r.DataRegister),d.WordBitAdjust[parseInt(L.indexPLC)]=o.ReadWordOfPLC(parseInt(L.PLC_WordStartBitAdjust),parseInt(L.PLC_LengthOfWordBitAdjust),r.DataRegister),d.BitDisplay[parseInt(L.indexPLC)]=o.ReadBitOfPLC(parseInt(L.PLC_WordStartBitDisplay),parseInt(L.PLC_LengthOfWordBitDisplay),r.DataRegister),d.WordDisplay[parseInt(L.indexPLC)]=o.ReadWordOfPLC(parseInt(L.PLC_WordStartWordDisplay),parseInt(L.PLC_LengthOfWordWordDisplay),r.DataRegister),d.WordAdjust[parseInt(L.indexPLC)]=o.ReadWordOfPLC(parseInt(L.PLC_WordStartWordAdjust),parseInt(L.PLC_LengthOfWordWordAdjust),r.DataRegister),d.DWordDisplay[parseInt(L.indexPLC)]=o.ReadDWordOfPLC(parseInt(L.PLC_WordStartDWordDisplay),parseInt(L.PLC_LengthOfWordDWordDisplay),r.DataRegister),d.DWordAdjust[parseInt(L.indexPLC)]=o.ReadDWordOfPLC(parseInt(L.PLC_WordStartDWordAdjust),parseInt(L.PLC_LengthOfWordDWordAdjust),r.DataRegister),d.ValueCommunicationPLC[parseInt(L.indexPLC)]=o.ReadWordOfPLC(parseInt(L.PLC_WordStartCommunicationPLC),parseInt(L.PLC_LengthOfWordCommunicationPLC),r.DataRegister),d.ValueRotate[parseInt(L.indexPLC)]=o.ReadWordOfPLC(parseInt(L.PLC_WordStartRotate),parseInt(L.PLC_LengthOfWordRotate),r.DataRegister))}var e;"Check_Data_Node"==t.payload&&(n.payload={plc:L.plc,host:L.host,port:L.port,rack:L.rack,slot:L.slot,indexPLC:L.indexPLC,PLC_WriteUnSafe:L.PLC_WriteUnSafe,PLC_Interval:L.PLC_Interval,PLC_Length_ReadWrite:L.PLC_Length_ReadWrite,PLC_Word_Start_ReadWrite:L.PLC_Word_Start_ReadWrite,PLC_WordStartElement:L.PLC_WordStartElement,PLC_LengthOfWordElement:L.PLC_LengthOfWordElement,PLC_WordStartBitDisplay:L.PLC_WordStartBitDisplay,PLC_LengthOfWordBitDisplay:L.PLC_LengthOfWordBitDisplay,PLC_WordStartBitAdjust:L.PLC_WordStartBitAdjust,PLC_LengthOfWordBitAdjust:L.PLC_LengthOfWordBitAdjust,PLC_WordStartWordDisplay:L.PLC_WordStartWordDisplay,PLC_LengthOfWordWordDisplay:L.PLC_LengthOfWordWordDisplay,PLC_WordStartWordAdjust:L.PLC_WordStartWordAdjust,PLC_LengthOfWordWordAdjust:L.PLC_LengthOfWordWordAdjust,PLC_WordStartDWordDisplay:L.PLC_WordStartDWordDisplay,PLC_LengthOfWordDWordDisplay:L.PLC_LengthOfWordDWordDisplay,PLC_WordStartDWordAdjust:L.PLC_WordStartDWordAdjust,PLC_LengthOfWordDWordAdjust:L.PLC_LengthOfWordDWordAdjust,PLC_WordStartRotate:L.PLC_WordStartRotate,PLC_LengthOfWordRotate:L.PLC_LengthOfWordRotate,PLC_WordStartComPC:L.PLC_WordStartComPC,PLC_LengthOfWordComPC:L.PLC_LengthOfWordComPC,PLC_Enable_String:L.PLC_Enable_String,PLC_WordStartString:L.PLC_WordStartString,PLC_LengthOfWordString:L.PLC_LengthOfWordString,PLC_NumberWordInString:L.PLC_NumberWordInString,PLC_IntervalWriteData:L.PLC_IntervalWriteData},L.send(n)),void 0!==t.payload.Profinet&&null==this.plc&&(L.log(C._("Have INPUT")),a.PLC_WordStartElement[parseInt(L.indexPLC)]=L.PLC_WordStartElement,a.PLC_LengthOfWordElement[parseInt(L.indexPLC)]=L.PLC_LengthOfWordElement,a.PLC_WordStartBitDisplay[parseInt(L.indexPLC)]=L.PLC_WordStartBitDisplay,a.PLC_LengthOfWordBitDisplay[parseInt(L.indexPLC)]=L.PLC_LengthOfWordBitDisplay,a.PLC_WordStartBitAdjust[parseInt(L.indexPLC)]=L.PLC_WordStartBitAdjust,a.PLC_LengthOfWordBitAdjust[parseInt(L.indexPLC)]=L.PLC_LengthOfWordBitAdjust,a.PLC_WordStartWordDisplay[parseInt(L.indexPLC)]=L.PLC_WordStartWordDisplay,a.PLC_LengthOfWordWordDisplay[parseInt(L.indexPLC)]=L.PLC_LengthOfWordWordDisplay,a.PLC_WordStartWordAdjust[parseInt(L.indexPLC)]=L.PLC_WordStartWordAdjust,a.PLC_LengthOfWordWordAdjust[parseInt(L.indexPLC)]=L.PLC_LengthOfWordWordAdjust,a.PLC_WordStartDWordDisplay[parseInt(L.indexPLC)]=L.PLC_WordStartDWordDisplay,a.PLC_LengthOfWordDWordDisplay[parseInt(L.indexPLC)]=L.PLC_LengthOfWordDWordDisplay,a.PLC_WordStartDWordAdjust[parseInt(L.indexPLC)]=L.PLC_WordStartDWordAdjust,a.PLC_LengthOfWordDWordAdjust[parseInt(L.indexPLC)]=L.PLC_LengthOfWordDWordAdjust,a.PLC_WriteUnSafe[parseInt(L.indexPLC)]=L.PLC_WriteUnSafe,a.PLC_WordStartRotate[parseInt(L.indexPLC)]=L.PLC_WordStartRotate,a.PLC_LengthOfWordRotate[parseInt(L.indexPLC)]=L.PLC_LengthOfWordRotate,a.PLC_WordStartComPC[parseInt(L.indexPLC)]=L.PLC_WordStartComPC,a.PLC_LengthOfWordComPC[parseInt(L.indexPLC)]=L.PLC_LengthOfWordComPC,a.PLC_IntervalWriteData[parseInt(L.indexPLC)]=L.PLC_IntervalWriteData,a.PLC_Enable_String[parseInt(L.indexPLC)]=L.PLC_Enable_String,a.PLC_WordStartString[parseInt(L.indexPLC)]=L.PLC_WordStartString,a.PLC_LengthOfWordString[parseInt(L.indexPLC)]=L.PLC_LengthOfWordString,a.PLC_NumberWordInString[parseInt(L.indexPLC)]=L.PLC_NumberWordInString,L.plc=new t.payload.Profinet,e={DataRegister:"DB1,INT"+L.PLC_Word_Start_ReadWrite+"."+L.PLC_Length_ReadWrite},L.plc.initiateConnection({port:L.port,host:L.host,rack:L.rack,slot:L.slot},function(t){void 0!==t&&(L.log(C._("Error: "+t)),L.status({fill:"grey",shape:"dot",text:"Error:"+t}));L.plc.setTranslationCB(function(t){return e[t]}),L.plc.addItems("DataRegister");t=setInterval(function(){L.plc.readAllItems(r)},parseInt(L.PLC_Interval));L.outstandingIntervals.push(t)}),a.COMMUNICATION_PLC_SIEMENS[parseInt(L.indexPLC)]=L.plc)})})};