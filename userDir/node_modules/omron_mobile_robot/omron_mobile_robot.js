module.exports=function(n){n.nodes.registerType("Omron Mobile Robot",function(t){n.nodes.createNode(this,t),this.host=t.host,this.port=+t.port,this.indexPLC=t.indexPLC,this.password=t.password,this.plc=null,this.closing=!1,this.connected=!1;var r,l=this,c=(t=this.context().global).get("VariableSystem"),p=(t.get("SubFunction"),{}),d=0;l.outstandingTimers=[],l.outstandingIntervals=[],l.connection_status=0,this.ConnectMobile=()=>{try{null!==l.plc&&l.plc.destroy(),l.plc.connect(parseInt(l.port),l.host,function(){l.status({fill:"green",shape:"dot",text:"Connected"})})}catch(t){l.warn("Log mobile robot: "+t)}},l.on("close",function(){for(null!==l.plc&&l.plc.destroy(),l.status({}),l.plc=null,l.connection_status=0;0<l.outstandingTimers.length;)clearTimeout(l.outstandingTimers.pop());for(;0<l.outstandingIntervals.length;)clearInterval(l.outstandingIntervals.pop());p.payload={connection_status:l.connection_status},l.send(p)}),l.on("input",function(t){var e;console.log("INPUT"),null==l.plc?(l.warn("Have INPUT"),e=require("net"),l.plc=new e.Socket,c.COMMUNICATION_MOBILE_ROBOT[parseInt(l.indexPLC)]=l.plc,c.COMMUNICATION_MOBILE_ROBOT_TIMER[parseInt(l.indexPLC)]=0,l.status({fill:"blue",shape:"dot",text:"Prepare Connect Mobile"}),this.ConnectMobile(),l.plc.on("close",function(){l.status({fill:"red",shape:"dot",text:"Connection Closed"})}),l.plc.on("error",function(){l.status({fill:"red",shape:"dot",text:"Have Error Occur"})}),e=setInterval(function(){c.COMMUNICATION_MOBILE_ROBOT[parseInt(l.indexPLC)]&&0==c.COMMUNICATION_MOBILE_ROBOT_TIMER[parseInt(l.indexPLC)]&&c.COMMUNICATION_MOBILE_ROBOT[parseInt(l.indexPLC)].write("status\r\n"),!isNaN(c.COMMUNICATION_MOBILE_ROBOT_TIMER[parseInt(l.indexPLC)])&&0<c.COMMUNICATION_MOBILE_ROBOT_TIMER[parseInt(l.indexPLC)]&&(c.COMMUNICATION_MOBILE_ROBOT_TIMER[parseInt(l.indexPLC)]=c.COMMUNICATION_MOBILE_ROBOT_TIMER[parseInt(l.indexPLC)]-1)},500),l.outstandingIntervals.push(e),e=setInterval(()=>{l.plc.writable&&l.plc.readable||(l.status({fill:"blue",shape:"dot",text:"Reconnect Mobile Robot"}),this.ConnectMobile())},2e3),l.outstandingIntervals.push(e),l.plc.on("data",function(t){var e,n,s,o,a,i;"Enter password:\r\n"==t?(l.status({fill:"blue",shape:"dot",text:"Set Password"}),l.plc.write(l.password+"\r\n")):(9999<(d+=1)&&(d=0),l.status({fill:"green",shape:"dot",text:"Getting data..."+d.toString()}),0==(tempCheck=t+"").indexOf("Status:")?(e=tempCheck.indexOf("Status:"),n=tempCheck.indexOf("StateOfCharge:"),s=tempCheck.indexOf("Location:"),o=tempCheck.indexOf("LocalizationScore:"),i=tempCheck.indexOf("Temperature:"),e=tempCheck.substring(e,n),n=tempCheck.substring(n,s).split(": "),tempCheck.substring(s,o),s=tempCheck.substring(o,i).split(": "),o=tempCheck.substring(i,i+16).split(": "),i=tempCheck.indexOf("Location"),a=tempCheck.indexOf("LocalizationScore:"),0<i&&0<a&&i<a&&(i=tempCheck.substring(i+10,a).split(" "),r={x:i[0],y:i[1],index:parseInt(l.indexPLC),data:{dataLocalizationScore:s[1],dataStatus:e,dataStateOfCharge:n[1],dataTemperature:o[1]}},c.PositionMobileRobot[parseInt(l.indexPLC)]=r)):(p.payload=t+"",l.send(p)))})):(l.log(n._(typeof t.payload.debug)),debug=t.payload.debug)})})};